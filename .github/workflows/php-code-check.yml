name: PHP Code Checks

on:
  workflow_call:
    inputs:
      php-version:
        required: true
        type: string
      composer:
        required: false
        type: string

jobs:
  php-code-check:
    name: 'PHP Code Check ${{ inputs.php-version }}'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout changes
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version || '8.3' }}
          extensions: dom, curl, xml, mbstring, zip, pdo, sqlite, bcmath, soap, intl, gd
          tools: composer:v2
          coverage: none

      - name: Set composer version to avoid conflicts
        if: github.head_ref != 'master' && github.head_ref != 'main' && github.head_ref != '4.x'
        run: composer config version 4.0.x-dev

      - name: Install composer dependencies
        run: composer ${{ inputs.composer || 'install --no-interaction --no-progress --no-scripts' }}

      - name: Remove composer version after use
        if: github.head_ref != 'master' && github.head_ref != 'main' && github.head_ref != '4.x'
        run: composer config --unset version

      - name: Run PHP Linting
        run: composer test:lint

      - name: Run PHP Rector
        run: composer test:rector

      - name: Run PHP Static Analysis
        run: composer test:static
