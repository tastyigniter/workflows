name: Auto Merge Release PR & Create Release

on:
  workflow_call:
    inputs:
      release-branch:
        description: "Branch where release PRs should be merged"
        required: false
        default: "main"
        type: string
    secrets:
      ACCESS_TOKEN:
        required: true

jobs:
  precheck:
    name: Check for Matching Release PR
    runs-on: ubuntu-latest
    outputs:
      found: ${{ steps.find.outputs.found }}
      number: ${{ steps.find.outputs.number }}
      title: ${{ steps.find.outputs.title }}
      body: ${{ steps.find.outputs.body }}
      version: ${{ steps.find.outputs.version }}

    steps:
      - name: Find matching Release PR and extract version
        id: find
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const fs = require('fs');
            const branch = context.ref.replace('refs/heads/', '');
            console.log(`üîç Looking for open PRs from branch: ${branch}`);
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open',
            });

            const pattern = /^Release v(\d+\.\d+\.\d+)$/;
            const match = prs.find(pr => pattern.test(pr.title));

            if (!match) {
              console.log('‚ùå No matching Release PR found.');
              fs.appendFileSync(process.env.GITHUB_OUTPUT, 'found=false\n');
            } else {
              const version = `v${match.title.match(pattern)[1]}`;
              const body = match.body || '';
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `found=true\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `number=${match.number}\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `title=${match.title.replace(/\n/g, ' ')}\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `body<<EOF\n${body}\nEOF\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `version=${version}\n`);
              console.log(`‚úÖ Found matching Release PR: #${match.number} - ${match.title}`);
            }

  auto-merge:
    name: Auto Merge & Create Release
    runs-on: ubuntu-latest
    needs: precheck
    if: needs.precheck.outputs.found == 'true'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Auto-merge the PR
        id: auto_merge
        uses: pascalgn/automerge-action@v0.16.3
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          PULL_REQUEST: ${{ needs.precheck.outputs.number }}
          MERGE_METHOD: merge
          MERGE_COMMIT_MESSAGE: pull-request-title-and-description
          MERGE_DELETE_BRANCH: false
          MERGE_FORKS: false
          MERGE_LABELS: ""
          MERGE_ERROR_FAIL: true
          MERGE_READY_STATE: "clean,has_hooks,unknown,unstable,blocked"

      - name: Create GitHub Release
        if: steps.auto_merge.outputs.mergeResult == 'merged'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ACCESS_TOKEN }}
          script: |
            const targetBranch = '${{ inputs.release-branch }}' || 'main';
            const version = '${{ needs.precheck.outputs.version }}';
            const releaseName = `Release ${version}`;
            const body = `${{ needs.precheck.outputs.body }}`;
            
            // Get the latest commit on the target branch
            const { data: branch } = await github.rest.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: targetBranch,
            });
            
            const targetCommitish = branch.commit.sha;
            console.log(`üîñ Creating release ${releaseName} on branch ${targetBranch} at commit ${targetCommitish}`);
            
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: releaseName,
              body: body,
              target_commitish: targetCommitish,
              draft: false,
              prerelease: false,
            });
            
            console.log(`‚úÖ Created release: ${release.html_url}`);
