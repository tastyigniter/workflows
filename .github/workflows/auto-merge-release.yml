name: Auto Merge Release PR & Create Release

on:
  workflow_call:
    inputs:
      release-branch:
        description: "Branch where release PRs should be merged"
        required: false
        default: "main"
        type: string

jobs:
  auto-merge:
    name: Auto Merge Release PR
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      checks: read
      actions: read
      statuses: read

    steps:
      - name: Find matching Release PR and extract version
        id: find_release_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            console.log(`üîç Looking for open PRs from branch: ${branch}`);
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open',
            });

            const releasePattern = /^Release v(\d+\.\d+\.\d+)$/;
            const releasePr = prs.find(pr => releasePattern.test(pr.title));

            if (releasePr) {
              const match = releasePr.title.match(releasePattern);
              const version = `v${match[1]}`;
              console.log(`‚úÖ Found release PR #${releasePr.number}: ${releasePr.title}`);
              console.log(`‚úÖ Extracted version: ${version}`);
              
              core.setOutput('number', releasePr.number);
              core.setOutput('title', releasePr.title);
              core.setOutput('body', releasePr.body || '');
              core.setOutput('version', version);
              core.setOutput('base', releasePr.base.ref);
            } else {
              console.log('‚ÑπÔ∏è No open PR found matching "Release vX.Y.Z"');
              core.setOutput('number', '');
            }

      - name: Stop if no matching release PR found
        if: >
          steps.find_release_pr.outputs.number == '' ||
          !startsWith(steps.find_release_pr.outputs.title, 'Release v')
        run: |
          echo "‚ö†Ô∏è Skipping auto-merge and release ‚Äî no valid 'Release vX.Y.Z' PR found."
          exit 0

      - name: Auto-merge the PR
        uses: pascalgn/automerge-action@v0.16.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULL_REQUEST: ${{ steps.find_release_pr.outputs.number }}
          MERGE_METHOD: merge
          MERGE_COMMIT_MESSAGE: "Auto-merged Release PR"
          MERGE_DELETE_BRANCH: false
          MERGE_FORKS: false
          MERGE_LABELS: ''
          MERGE_ERROR_FAIL: true

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.find_release_pr.outputs.version }}
          release_name: Release ${{ steps.find_release_pr.outputs.version }}
          body: ${{ steps.find_release_pr.outputs.body }}
          draft: false
          prerelease: false
