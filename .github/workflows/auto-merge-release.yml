name: Auto Merge Release PR & Create Release

on:
  workflow_call:
    inputs:
      release-branch:
        description: "Branch where release PRs should be merged"
        required: false
        default: "main"
        type: string

jobs:
  debug-context:
    name: üêõ Debug Context
    runs-on: ubuntu-latest
    # Always run, no conditions
    steps:
      - name: Dump event data
        continue-on-error: true
        run: |
          echo "üîé Event name: ${{ github.event_name }}"
          echo "üîé Ref: ${{ github.ref }}"
          echo "üîé Head ref: ${{ github.head_ref }}"
          echo "üîé Base ref: ${{ github.base_ref }}"
          echo "üîé PR title: ${{ github.event.pull_request.title }}"
          echo "üîé PR base ref: ${{ github.event.pull_request.base.ref }}"
          echo "üîé Draft status: ${{ github.event.pull_request.draft }}"
          echo "üîé Release branch input: ${{ inputs.release-branch }}"
          echo "üîé Conditions to match:"
          echo "    - event_name == 'pull_request'"
          echo "    - base.ref == inputs.release-branch"
          echo "    - draft == false"
          echo "    - title starts with 'Release v'"
          echo "---------------------------------------"
          echo "If this job runs but 'auto-merge' is skipped,"
          echo "it means one or more of these values don't match."

  auto-merge:
    name: Auto Merge Release PR
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      checks: read
      actions: read
      statuses: read

    steps:
      - name: Find associated pull request
        id: find_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (prs.data.length > 0) {
              const pr = prs.data[0];
              console.log(`‚úÖ Found PR #${pr.number}: ${pr.title}`);
              core.setOutput('number', pr.number);
              core.setOutput('title', pr.title);
              core.setOutput('body', pr.body || '');
              core.setOutput('base', pr.base.ref);
            } else {
              console.log('‚ÑπÔ∏è No open PR found for this branch.');
              core.setOutput('number', '');
            }

      - name: Debug PR info
        run: |
          echo "PR number: ${{ steps.find_pr.outputs.number }}"
          echo "PR title: ${{ steps.find_pr.outputs.title }}"
          echo "PR base: ${{ steps.find_pr.outputs.base }}"
          echo "Triggered by ref: ${{ github.ref }}"

      - name: Stop if no matching release PR found
        if: >
          steps.find_pr.outputs.number == '' ||
          !startsWith(steps.find_pr.outputs.title, 'Release v')
        run: |
          echo "‚ö†Ô∏è Skipping auto-merge and release ‚Äî no valid 'Release vX.Y.Z' PR found."
          exit 0

      - name: Extract version from PR title
        id: extract_version
        run: |
          title="${{ steps.find_pr.outputs.title }}"
          if [[ "$title" =~ ^Release[[:space:]]v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            version="v${BASH_REMATCH[1]}"
            echo "‚úÖ Version extracted: $version"
            echo "version=$version" >> $GITHUB_OUTPUT
          else
            echo "‚ùå PR title does not match 'Release vX.Y.Z'"
            exit 1
          fi


      - name: Auto-merge the PR
        uses: pascalgn/automerge-action@v0.16.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULL_REQUEST_NUMBER: ${{ steps.find_pr.outputs.number }}
          MERGE_METHOD: merge
          MERGE_COMMIT_MESSAGE: "Auto-merged Release PR"
          MERGE_DELETE_BRANCH: false

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract_version.outputs.version }}
          release_name: Release ${{ steps.extract_version.outputs.version }}
          body: ${{ steps.find_pr.outputs.body }}
          draft: false
          prerelease: false
